<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Accademia delle Lingue - Accesso</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1e3a5f; --primary-dark: #152a45; --secondary: #8b0000;
            --success: #276749; --error: #c53030; --warning: #d97706;
            --bg-primary: #f5f5f0; --bg-card: #ffffff; --border: #d4d4c8;
            --text-primary: #2c3e50; --text-secondary: #5a6c7d;
            --accent: #3b82f6; --italiano: #c9a227; --trinity: #2563eb; --toefl: #dc2626;
        }
        html, body { height: 100%; font-family: 'Georgia', 'Times New Roman', serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.4; }
        .academic-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 1.5rem 1rem; border-bottom: 4px solid var(--secondary); text-align: center; position: relative; }
        .academic-header h1 { font-size: 1.3rem; font-weight: normal; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.3rem; }
        .academic-header p { font-size: 0.75rem; font-style: italic; opacity: 0.9; margin: 0; }
        .admin-corner { position: absolute; top: 10px; right: 10px; font-size: 0.65rem; color: rgba(255,255,255,0.7); cursor: pointer; text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px; }
        .admin-corner:hover { color: white; text-decoration: underline; }
        .main-container { min-height: calc(100vh - 100px); display: flex; align-items: center; justify-content: center; padding: 20px 10px; }
        .login-box { width: 100%; max-width: 420px; background: var(--bg-card); border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        .login-header { background: var(--primary); padding: 20px; text-align: center; color: white; border-bottom: 2px solid var(--secondary); }
        .login-header h2 { font-size: 1.1rem; font-weight: normal; letter-spacing: 0.5px; margin-bottom: 4px; }
        .login-body { padding: 24px; }
        .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 24px; }
        .tab { flex: 1; padding: 12px; background: transparent; border: none; font-family: inherit; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: var(--primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.3px; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); font-size: 0.9rem; font-family: inherit; background: #fafafa; }
        .form-input:focus { outline: none; border-color: var(--primary); background: white; }
        textarea.form-input { min-height: 80px; resize: vertical; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: background 0.2s; margin-top: 8px; }
        .btn:hover { background: var(--primary-dark); }
        .btn:disabled { background: var(--text-secondary); cursor: not-allowed; }
        .btn-secondary { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover { background: var(--primary); color: white; }
        .btn-success { background: var(--success); }
        .platform-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 16px; }
        .platform-btn { padding: 12px 16px; border: 2px solid var(--border); background: white; cursor: pointer; font-family: inherit; font-size: 0.85rem; font-weight: 600; text-align: left; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .platform-btn:hover { transform: translateX(4px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .platform-btn.selected { border-width: 3px; }
        .platform-btn.italiano { border-color: var(--italiano); color: var(--italiano); }
        .platform-btn.italiano.selected { background: var(--italiano); color: white; }
        .platform-btn.trinity { border-color: var(--trinity); color: var(--trinity); }
        .platform-btn.trinity.selected { background: var(--trinity); color: white; }
        .platform-btn.toefl { border-color: var(--toefl); color: var(--toefl); }
        .platform-btn.toefl.selected { background: var(--toefl); color: white; }
        .platform-icon { font-size: 1.3rem; }
        .platform-info { flex: 1; }
        .platform-name { display: block; font-weight: 700; font-size: 0.9rem; }
        .platform-desc { display: block; font-size: 0.75rem; font-weight: 400; opacity: 0.9; margin-top: 1px; }
        .alert { padding: 10px 12px; margin-bottom: 16px; font-size: 0.8rem; border-left: 3px solid; display: none; }
        .alert-error { background: #fed7d7; color: var(--error); border-left-color: var(--error); }
        .alert-success { background: #c6f6d5; color: var(--success); border-left-color: var(--success); }
        .alert-warning { background: #fef3c7; color: var(--warning); border-left-color: var(--warning); }
        .password-display { background: #f0fdf4; border: 2px dashed var(--success); padding: 20px; margin: 16px 0; text-align: center; display: none; }
        .password-display.show { display: block; animation: fadeIn 0.5s ease; }
        .password-label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .password-value { font-family: 'Courier New', monospace; font-size: 1.3rem; font-weight: bold; color: var(--primary); background: white; padding: 10px 20px; border: 2px solid var(--border); display: inline-block; letter-spacing: 2px; margin: 8px 0; word-break: break-all; }
        .copy-btn { background: var(--success); color: white; border: none; padding: 8px 16px; font-size: 0.8rem; cursor: pointer; margin-top: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .copy-btn:hover { background: #1e5c3e; }
        .form-links { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center; }
        .form-links p { font-size: 0.8rem; color: var(--text-secondary); margin: 0 0 8px 0; }
        .form-links a { color: var(--accent); text-decoration: none; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .form-links a:hover { text-decoration: underline; }
        .login-footer { padding: 16px; text-align: center; border-top: 1px solid var(--border); background: var(--bg-primary); }
        .login-footer p { font-size: 0.7rem; color: var(--text-secondary); margin: 0; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 400px; border: 2px solid var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { background: var(--primary); color: white; padding: 16px 20px; border-bottom: 2px solid var(--secondary); }
        .modal-header h3 { font-size: 1rem; font-weight: normal; letter-spacing: 0.5px; margin: 0; }
        .modal-body { padding: 24px; }
        .modal-close { float: right; color: white; font-size: 1.5rem; cursor: pointer; line-height: 1; margin-top: -4px; }
        #adminDashboard { display: none; min-height: 100vh; }
        .admin-nav { background: var(--primary); color: white; padding: 0 20px; height: 56px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--secondary); }
        .admin-nav-title { font-size: 1rem; font-weight: normal; letter-spacing: 0.5px; }
        .admin-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .admin-card { background: white; border: 1px solid var(--border); padding: 20px; border-left: 4px solid var(--secondary); }
        .admin-card h4 { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .admin-card .value { font-size: 2rem; color: var(--primary); font-weight: bold; }
        .data-table { width: 100%; border-collapse: collapse; background: white; border: 1px solid var(--border); font-size: 0.85rem; }
        .data-table th { background: var(--primary); color: white; padding: 12px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; }
        .data-table td { padding: 12px; border-bottom: 1px solid var(--border); }
        .data-table tr:hover { background: var(--bg-primary); }
        .badge { padding: 4px 8px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #dcfce7; color: #166534; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }
        .action-btn { padding: 6px 12px; font-size: 0.75rem; border: none; cursor: pointer; margin-right: 4px; text-transform: uppercase; }
        .btn-small { padding: 6px 12px; font-size: 0.75rem; width: auto; margin-top: 0; }
        .device-list { background: var(--bg-primary); padding: 12px; margin: 8px 0; border-left: 3px solid var(--warning); font-size: 0.8rem; }
        .device-item { padding: 4px 0; border-bottom: 1px solid var(--border); }
        @media (max-width: 480px) {
            .academic-header h1 { font-size: 1.1rem; }
            .login-body { padding: 16px; }
            .tab { font-size: 0.7rem; padding: 10px 8px; }
        }
    </style>
</head>
<body>
    <header class="academic-header">
        <a href="#" class="admin-corner" onclick="openAdminModal()">‚öôÔ∏è Admin</a>
        <h1>Accademia delle Lingue</h1>
        <p>Piattaforma e-learning - Trinity College London - Sede accreditata n. 68499</p>
        <p style="font-size: 0.7rem; margin-top: 4px; opacity: 0.8;">Nucleo Educativo per la Formazione Europea al Lavoro Internazionale</p>
    </header>

    <div id="mainInterface" class="main-container">
        <div class="login-box">
            <div class="login-header">
                <h2>Accesso alla Piattaforma</h2>
                <p>Seleziona la modalit√† di accesso</p>
            </div>
            <div class="login-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('student')">üë§ Studente</button>
                    <button class="tab" onclick="switchTab('request')">üìù Richiesta Accesso</button>
                </div>
                <div id="alertBox" class="alert"></div>

                <!-- LOGIN STUDENTE -->
                <div id="studentTab" class="tab-content active">
                    <form id="studentLoginForm">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="studentEmail" class="form-input" placeholder="nome@email.it" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="studentPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn">Accedi</button>
                    </form>
                    <div class="form-links">
                        <p>Non hai ancora un account?</p>
                        <a onclick="switchTab('request')">Richiedi accesso ‚Üí</a>
                    </div>
                </div>

                <!-- RICHIESTA ACCESSO -->
                <div id="requestTab" class="tab-content">
                    <div id="passwordDisplay" class="password-display">
                        <div class="password-label">‚úÖ Richiesta Inviata!</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px;">
                            La tua richiesta √® stata inviata agli amministratori.<br>
                            Riceverai una email con le credenziali dopo l'approvazione.
                        </div>
                        <button class="copy-btn" onclick="switchTab('student')">Vai al Login</button>
                    </div>

                    <form id="requestForm">
                        <div class="form-group">
                            <label class="form-label">Seleziona Piattaforma *</label>
                            <div class="platform-grid">
                                <button type="button" class="platform-btn italiano" onclick="selectPlatform('italiano')">
                                    <span class="platform-icon">üáÆüáπ</span>
                                    <span class="platform-info">
                                        <span class="platform-name">ITALIANO L2</span>
                                        <span class="platform-desc">Certificazione CE.CO.L</span>
                                    </span>
                                </button>
                                <button type="button" class="platform-btn trinity" onclick="selectPlatform('trinity')">
                                    <span class="platform-icon">üá¨üáß</span>
                                    <span class="platform-info">
                                        <span class="platform-name">INGLESE TRINITY</span>
                                        <span class="platform-desc">Trinity College London</span>
                                    </span>
                                </button>
                                <button type="button" class="platform-btn toefl" onclick="selectPlatform('toefl')">
                                    <span class="platform-icon">üéì</span>
                                    <span class="platform-info">
                                        <span class="platform-name">INGLESE TOEFL</span>
                                        <span class="platform-desc">Test of English as Foreign Language</span>
                                    </span>
                                </button>
                            </div>
                            <input type="hidden" id="selectedPlatform" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome completo *</label>
                            <input type="text" id="reqName" class="form-input" placeholder="Mario Rossi" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="reqEmail" class="form-input" placeholder="mario.rossi@email.it" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Motivazione *</label>
                            <textarea id="reqMotivation" class="form-input" placeholder="Spiega perch√© vuoi accedere alla piattaforma..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">üì§ Invia Richiesta</button>
                    </form>
                    <div class="form-links">
                        <p>Hai gi√† un account?</p>
                        <a onclick="switchTab('student')">‚Üê Torna al login</a>
                    </div>
                </div>
            </div>
            <div class="login-footer">
                <p>¬© 2024 Accademia delle Lingue<br><small>Tutti i diritti riservati</small></p>
            </div>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="adminModal" class="modal-overlay" onclick="closeAdminModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-close" onclick="closeAdminModal()">&times;</span>
                <h3>‚öôÔ∏è Accesso Amministrazione</h3>
            </div>
            <div class="modal-body">
                <div id="adminAlert" class="alert" style="margin-top: 0;"></div>
                <form id="adminLoginForm">
                    <div class="form-group">
                        <label class="form-label">Email Admin</label>
                        <input type="email" id="adminEmail" class="form-input" placeholder="admin@accademia.it" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="adminPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn">Accedi all'Area Riservata</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminDashboard">
        <nav class="admin-nav">
            <div class="admin-nav-title">‚öôÔ∏è PANNELLO AMMINISTRAZIONE</div>
            <button onclick="adminLogout()" class="btn btn-secondary" style="width: auto; padding: 8px 16px; font-size: 0.75rem;">Logout</button>
        </nav>
        <div class="admin-container">
            <div style="margin-bottom: 24px;">
                <h2 style="color: var(--primary); border-bottom: 2px solid var(--secondary); padding-bottom: 8px; font-weight: normal;">Dashboard</h2>
            </div>
            <div class="admin-grid">
                <div class="admin-card">
                    <h4>Utenti Totali</h4>
                    <div class="value" id="statUsers">0</div>
                </div>
                <div class="admin-card">
                    <h4>Richieste in Attesa</h4>
                    <div class="value" id="statPending">0</div>
                </div>
                <div class="admin-card">
                    <h4>Test Completati</h4>
                    <div class="value" id="statScores">0</div>
                </div>
                <div class="admin-card">
                    <h4>Media Punteggi</h4>
                    <div class="value" id="statAvg">0%</div>
                </div>
            </div>

            <div style="background: white; border: 1px solid var(--border); margin-bottom: 24px;">
                <div style="padding: 16px; border-bottom: 2px solid var(--border); background: var(--bg-primary);">
                    <h3 style="font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px;">üìù Richieste Accesso</h3>
                </div>
                <div style="padding: 16px; overflow-x: auto;">
                    <table class="data-table" id="requestsTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Piattaforma</th>
                                <th>Motivazione</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div style="background: white; border: 1px solid var(--border);">
                <div style="padding: 16px; border-bottom: 2px solid var(--border); background: var(--bg-primary); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px;">üë• Utenti Registrati</h3>
                    <button class="btn btn-small btn-success" onclick="exportData()">üìä Esporta CSV</button>
                </div>
                <div style="padding: 16px; overflow-x: auto;">
                    <table class="data-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Piattaforma</th>
                                <th>Dispositivi</th>
                                <th>Primo Accesso</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE
        const ADMIN_EMAIL = 'admin@accademia.it';
        const ADMIN_PASSWORD = 'Admin2024!';
        const MAX_DEVICES = 1; // Solo 1 dispositivo per studente

        // Database unificato
        let db = { users: [], requests: [], scores: [] };
        let selectedPlatform = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            initDB();
            
            // Check sessioni
            const adminSession = sessionStorage.getItem('adminLoggedIn');
            const studentSession = sessionStorage.getItem('studentLoggedIn');
            
            if (adminSession === 'true') {
                showAdminDashboard();
            }
        });

        function initDB() {
            const stored = localStorage.getItem('accademia_data');
            if (stored) {
                db = JSON.parse(stored);
                // Migrazione dati vecchi se necessario
                if (!db.users) db.users = [];
                if (!db.requests) db.requests = [];
                if (!db.scores) db.scores = [];
            } else {
                // Crea admin di default
                db.users.push({
                    id: 'admin001',
                    email: ADMIN_EMAIL,
                    password: ADMIN_PASSWORD,
                    name: 'Amministratore',
                    role: 'admin',
                    platform: 'trinity',
                    devices: [],
                    created: new Date().toISOString(),
                    firstLogin: false
                });
                saveDB();
            }
        }

        function saveDB() {
            localStorage.setItem('accademia_data', JSON.stringify(db));
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'student') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('studentTab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('requestTab').classList.add('active');
            }
            hideAlert();
        }

        function selectPlatform(platform) {
            selectedPlatform = platform;
            document.querySelectorAll('.platform-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector('.platform-btn.' + platform).classList.add('selected');
            document.getElementById('selectedPlatform').value = platform;
        }

        // ==================== STUDENT LOGIN ====================
        document.getElementById('studentLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('studentEmail').value.trim();
            const password = document.getElementById('studentPassword').value;
            
            const user = db.users.find(u => u.email === email && u.password === password && u.role === 'student');
            
            if (!user) {
                showAlert('error', 'Credenziali non valide');
                return;
            }

            // Controllo dispositivi - SOLO 1 dispositivo
            if (!user.devices) user.devices = [];
            const deviceId = getDeviceId();
            
            // Se √® il primo login, permetti sempre
            if (user.firstLogin !== false) {
                // Primo login - salva dispositivo e marca come loggato
                user.devices = [{ id: deviceId, timestamp: new Date().toISOString() }];
                user.firstLogin = false;
                saveDB();
                
                sessionStorage.setItem('studentLoggedIn', 'true');
                sessionStorage.setItem('studentEmail', email);
                sessionStorage.setItem('studentId', user.id);
                sessionStorage.setItem('firstLogin', 'true'); // Flag per cambio password
                
                showAlert('success', 'Primo accesso! Reindirizzamento per cambio password...');
                setTimeout(() => {
                    window.location.href = 'cambio-password.html';
                }, 1500);
                return;
            }

            // Login successivo - verifica dispositivo
            if (!user.devices.some(d => d.id === deviceId)) {
                showAlert('error', 'Questo dispositivo non √® autorizzato. Puoi accedere solo dal dispositivo registrato o contatta l\'amministratore.');
                return;
            }

            // Dispositivo riconosciuto - aggiorna timestamp
            user.devices[0].timestamp = new Date().toISOString();
            saveDB();

            sessionStorage.setItem('studentLoggedIn', 'true');
            sessionStorage.setItem('studentEmail', email);
            sessionStorage.setItem('studentId', user.id);
            
            showAlert('success', 'Accesso effettuato! Reindirizzamento...');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        });

        function getDeviceId() {
            let deviceId = localStorage.getItem('accademia_device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('accademia_device_id', deviceId);
            }
            return deviceId;
        }

        // ==================== RICHIESTA ACCESSO ====================
        document.getElementById('requestForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('reqName').value.trim();
            const email = document.getElementById('reqEmail').value.trim();
            const motivation = document.getElementById('reqMotivation').value.trim();
            const platform = document.getElementById('selectedPlatform').value;

            if (!platform) {
                showAlert('error', 'Seleziona una piattaforma');
                return;
            }

            // Verifica duplicati
            if (db.users.find(u => u.email === email)) {
                showAlert('error', 'Esiste gi√† un utente con questa email');
                return;
            }

            if (db.requests.find(r => r.email === email && r.status === 'pending')) {
                showAlert('error', 'Hai gi√† una richiesta in attesa di approvazione');
                return;
            }

            // Salva richiesta in attesa
            db.requests.push({
                id: 'req_' + Date.now(),
                name: name,
                email: email,
                motivation: motivation,
                platform: platform,
                status: 'pending',
                created: new Date().toISOString()
            });

            saveDB();

            // Mostra conferma
            document.getElementById('requestForm').style.display = 'none';
            document.getElementById('passwordDisplay').classList.add('show');
        });

        // ==================== ADMIN FUNCTIONS ====================
        function openAdminModal() {
            document.getElementById('adminModal').classList.add('show');
        }

        function closeAdminModal(e) {
            if (!e || e.target.id === 'adminModal' || e.target.className === 'modal-close') {
                document.getElementById('adminModal').classList.remove('show');
                document.getElementById('adminAlert').style.display = 'none';
            }
        }

        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminDashboard();
                closeAdminModal();
            } else {
                const alert = document.getElementById('adminAlert');
                alert.textContent = 'Credenziali non valide';
                alert.className = 'alert alert-error';
                alert.style.display = 'block';
            }
        });

        function showAdminDashboard() {
            document.getElementById('mainInterface').style.display = 'none';
            document.querySelector('.academic-header').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            updateAdminStats();
            loadAdminTables();
        }

        function adminLogout() {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        function updateAdminStats() {
            const students = db.users.filter(u => u.role !== 'admin');
            document.getElementById('statUsers').textContent = students.length;
            document.getElementById('statPending').textContent = db.requests.filter(r => r.status === 'pending').length;
            document.getElementById('statScores').textContent = db.scores.length;
            
            const avg = db.scores.length > 0 
                ? Math.round(db.scores.reduce((a, s) => a + s.percentage, 0) / db.scores.length)
                : 0;
            document.getElementById('statAvg').textContent = avg + '%';
        }

        function loadAdminTables() {
            // Richieste
            const reqBody = document.querySelector('#requestsTable tbody');
            const pending = db.requests.filter(r => r.status === 'pending');
            
            if (pending.length === 0) {
                reqBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Nessuna richiesta in attesa</td></tr>';
            } else {
                reqBody.innerHTML = pending.map(r => `
                    <tr>
                        <td>${new Date(r.created).toLocaleDateString('it-IT')}</td>
                        <td>${r.name}</td>
                        <td>${r.email}</td>
                        <td>${r.platform.toUpperCase()}</td>
                        <td>${r.motivation.substring(0, 30)}...</td>
                        <td><span class="badge badge-pending">In attesa</span></td>
                        <td>
                            <button class="action-btn btn-success" onclick="approveRequest('${r.id}')">Approva & Invia</button>
                            <button class="action-btn" style="background: var(--error); color: white;" onclick="rejectRequest('${r.id}')">Rifiuta</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Utenti
            const userBody = document.querySelector('#usersTable tbody');
            const students = db.users.filter(u => u.role !== 'admin');
            
            if (students.length === 0) {
                userBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Nessun utente</td></tr>';
            } else {
                userBody.innerHTML = students.map(u => `
                    <tr>
                        <td>${u.id.substr(-6)}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.platform ? u.platform.toUpperCase() : 'N/D'}</td>
                        <td>${u.devices && u.devices.length > 0 ? '1/1 ' + u.devices[0].id.substr(-8) : '0/1'}</td>
                        <td>${u.firstLogin === false ? '‚úì Completato' : '‚è≥ In attesa'}</td>
                        <td>
                            <button class="action-btn" style="background: var(--warning); color: white;" onclick="resetDevice('${u.id}')">Reset Disp.</button>
                            <button class="action-btn" style="background: var(--error); color: white;" onclick="deleteUser('${u.id}')">Elimina</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function approveRequest(id) {
            const req = db.requests.find(r => r.id === id);
            if (!req) return;

            // Genera password
            const password = generatePassword(req.platform);
            
            // Crea utente
            const newUser = {
                id: 'user_' + Date.now(),
                email: req.email,
                password: password,
                name: req.name,
                platform: req.platform,
                role: 'student',
                devices: [],
                created: new Date().toISOString(),
                firstLogin: true // Deve cambiare password al primo login
            };

            db.users.push(newUser);
            req.status = 'approved';
            req.approvedAt = new Date().toISOString();
            req.generatedPassword = password;
            
            saveDB();
            loadAdminTables();
            updateAdminStats();

            // Mostra dialogo con credenziali
            alert(`‚úÖ RICHIESTA APPROVATA E PASSWORD GENERATA\n\nStudente: ${req.name}\nEmail: ${req.email}\nPassword: ${password}\n\nComunica queste credenziali allo studente. Al primo login dovr√† cambiare password.`);
        }

        function rejectRequest(id) {
            if (!confirm('Rifiutare questa richiesta?')) return;
            const req = db.requests.find(r => r.id === id);
            if (req) {
                req.status = 'rejected';
                req.rejectedAt = new Date().toISOString();
                saveDB();
                loadAdminTables();
            }
        }

        function resetDevice(userId) {
            const user = db.users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`Reset dispositivo per ${user.name}?\n\nL'utente potr√† accedere da un nuovo dispositivo e dovr√† reimpostare la password.`)) {
                user.devices = [];
                user.firstLogin = true; // Forza cambio password
                saveDB();
                loadAdminTables();
                alert('‚úÖ Dispositivo resettato. L\'utente dovr√† fare il primo accesso da zero.');
            }
        }

        function deleteUser(id) {
            if (!confirm('Eliminare permanentemente questo utente?')) return;
            db.users = db.users.filter(u => u.id !== id);
            saveDB();
            loadAdminTables();
            updateAdminStats();
        }

        function generatePassword(platform) {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let middle = "";
            for (let i = 0; i < 10; i++) {
                middle += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            const prefixes = { 'italiano': 'ITA_', 'trinity': 'TRI_', 'toefl': 'TOF_' };
            const suffixes = { 'italiano': '_CECOL', 'trinity': '_TRIN', 'toefl': '_TOEFL' };
            return prefixes[platform] + middle + suffixes[platform];
        }

        function exportData() {
            const students = db.users.filter(u => u.role !== 'admin');
            if (students.length === 0) return alert('Nessun dato da esportare');
            
            let csv = 'Nome;Email;Piattaforma;Data Registrazione;Primo Accesso\n';
            students.forEach(u => {
                csv += `${u.name};${u.email};${u.platform || 'N/D'};${new Date(u.created).toLocaleDateString('it-IT')};${u.firstLogin === false ? 'Completato' : 'In attesa'}\n`;
            });
            
            downloadCSV(csv, 'utenti_accademia');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ==================== UTILITIES ====================
        function showAlert(type, message) {
            const alert = document.getElementById('alertBox');
            alert.className = 'alert alert-' + type;
            alert.textContent = (type === 'success' ? '‚úÖ ' : '‚ùå ') + message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function hideAlert() {
            document.getElementById('alertBox').style.display = 'none';
        }
    </script>
</body>
</html>
