<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello Amministrazione - Accademia delle Lingue</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1e3a5f;
            --primary-dark: #152a45;
            --secondary: #8b0000;
            --success: #276749;
            --error: #c53030;
            --warning: #d97706;
            --bg-primary: #f5f5f0;
            --bg-card: #ffffff;
            --border: #d4d4c8;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --accent: #c9a227;
        }

        body { 
            font-family: 'Georgia', 'Times New Roman', serif; 
            background: var(--bg-primary); 
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header Accademico */
        .academic-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            border-bottom: 4px solid var(--secondary);
            text-align: center;
        }

        .academic-header h1 {
            font-size: 1.8rem;
            font-weight: normal;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .academic-header p {
            font-size: 0.9rem;
            font-style: italic;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Login Section */
        .login-section { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: var(--bg-primary);
            padding: 20px; 
        }

        .login-container { 
            width: 100%; 
            max-width: 480px; 
            background: var(--bg-card); 
            border-radius: 0; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .login-header { 
            background: var(--primary); 
            padding: 40px 30px; 
            text-align: center; 
            color: white;
            border-bottom: 3px solid var(--secondary);
        }

        .login-logo { 
            font-size: 3rem; 
            margin-bottom: 16px; 
        }

        .login-body { 
            padding: 32px; 
        }

        .form-group { 
            margin-bottom: 20px; 
        }

        .form-label { 
            display: block; 
            font-size: 0.875rem; 
            font-weight: 600; 
            margin-bottom: 8px;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input { 
            width: 100%; 
            padding: 12px 16px; 
            border: 1px solid var(--border); 
            border-radius: 0; 
            font-size: 1rem;
            font-family: inherit;
            background: #fafafa;
        }

        .form-input:focus { 
            outline: none; 
            border-color: var(--primary);
            background: white;
        }

        .btn { 
            width: 100%; 
            padding: 14px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 0; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }

        .btn:hover { 
            background: var(--primary-dark);
        }

        .btn-secondary { 
            background: transparent; 
            color: var(--primary); 
            border: 2px solid var(--primary); 
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success { 
            background: var(--success); 
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--error);
        }

        .form-footer { 
            text-align: center; 
            margin-top: 24px; 
            padding-top: 24px; 
            border-top: 1px solid var(--border); 
        }

        .form-footer a { 
            color: var(--primary); 
            font-weight: 600; 
            text-decoration: none; 
        }

        .form-footer a:hover { 
            text-decoration: underline; 
        }

        .alert { 
            padding: 12px 16px; 
            border-radius: 0; 
            margin-bottom: 16px; 
            display: none;
            border-left: 4px solid;
        }

        .alert-error { 
            background: #fed7d7; 
            color: var(--error); 
            display: block;
            border-left-color: var(--error);
        }

        .alert-success { 
            background: #c6f6d5; 
            color: var(--success); 
            display: block;
            border-left-color: var(--success);
        }

        .alert-warning {
            background: #fef3c7;
            color: var(--warning);
            display: block;
            border-left-color: var(--warning);
        }

        /* Dashboard */
        .dashboard { 
            display: none; 
            min-height: 100vh; 
        }

        .top-nav { 
            background: var(--primary); 
            color: white; 
            padding: 0 24px; 
            height: 64px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            border-bottom: 3px solid var(--secondary);
        }

        .main-container { 
            display: flex; 
            min-height: calc(100vh - 64px); 
        }

        .sidebar { 
            width: 300px; 
            background: var(--bg-card); 
            border-right: 1px solid var(--border); 
            padding: 24px 0;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
            overflow-y: auto;
            max-height: calc(100vh - 64px);
        }

        .nav-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px 16px; 
            margin: 0 12px 4px 12px;
            border-radius: 0; 
            cursor: pointer; 
            color: var(--text-secondary);
            border-left: 3px solid transparent;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .nav-item:hover { 
            background: var(--bg-primary); 
            color: var(--text-primary);
            border-left-color: var(--border);
        }

        .nav-item.active { 
            background: var(--bg-primary); 
            color: var(--primary);
            border-left-color: var(--secondary);
            font-weight: 600;
        }

        .content { 
            flex: 1; 
            padding: 32px; 
            background: var(--bg-primary);
            overflow-y: auto;
            max-height: calc(100vh - 64px);
        }

        .section { 
            display: none; 
        }

        .section.active { 
            display: block; 
        }

        .card { 
            background: var(--bg-card); 
            border-radius: 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            border: 1px solid var(--border); 
            margin-bottom: 24px; 
        }

        .card-header { 
            padding: 20px 24px; 
            border-bottom: 2px solid var(--border); 
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.95rem;
        }

        .card-body { 
            padding: 24px; 
        }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 24px;
            text-align: center;
            border-left: 4px solid var(--secondary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Times New Roman', serif;
        }

        .section-title {
            font-size: 1.75rem;
            color: var(--primary);
            font-weight: normal;
            margin-bottom: 8px;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 12px;
        }

        .section-subtitle {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 24px;
        }

        /* Menu Category */
        .menu-category {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 16px 12px 8px 12px;
            padding-left: 12px;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }
        .data-table th {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .data-table tr:hover {
            background: var(--bg-primary);
        }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-approved {
            background: #dcfce7;
            color: #166534;
        }
        .badge-sent {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Password Generator */
        .password-box {
            background: #f0fdf4;
            border: 2px dashed var(--success);
            padding: 2rem;
            text-align: center;
        }
        .password-display {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            color: var(--primary);
            background: white;
            padding: 1rem;
            margin: 1rem 0;
            letter-spacing: 2px;
            border: 2px solid var(--border);
        }

        /* Breadcrumbs */
        .breadcrumbs {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: -32px -32px 24px -32px;
        }
        .breadcrumbs strong {
            color: var(--text-primary);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--primary);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .modal-header {
            border-bottom: 2px solid var(--border);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin: 0;
        }

        .device-list {
            background: var(--bg-primary);
            padding: 1rem;
            margin: 1rem 0;
            border-left: 3px solid var(--warning);
        }

        .device-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 100;
                max-height: 60vh;
                overflow-y: auto;
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginSection" class="login-section">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">‚öôÔ∏è</div>
                <h1 style="font-size: 1.3rem; line-height: 1.3; font-weight: normal;">PANNELLO AMMINISTRAZIONE</h1>
                <p style="font-size: 0.8rem; margin-top: 8px; font-style: italic;">Accademia delle Lingue</p>
                <p style="font-size: 0.75rem; margin-top: 4px; opacity: 0.8;">Nucleo Educativo per la Formazione Europea al Lavoro Internazionale</p>
            </div>
            <div class="login-body">
                <div id="loginError" class="alert alert-error" style="display: none;"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email Amministratore</label>
                        <input type="email" id="loginEmail" class="form-input" required placeholder="Inserisci email amministratore"/>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required placeholder="Inserisci password"/>
                    </div>
                    <button type="submit" class="btn">Accedi all'Area Riservata</button>

                    <div class="form-footer">
                        <p><a href="../index.html">‚Üê Torna alla Piattaforma Studenti</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL LIMITO DISPOSITIVI -->
    <div id="deviceModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Limite Dispositivi Raggiunto</h3>
            </div>
            <div id="modalBody">
                <!-- Contenuto dinamico -->
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closeDeviceModal()" style="width: auto;">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD ADMIN -->
    <div id="dashboard" class="dashboard">
        <nav class="top-nav">
            <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:1.5rem;">‚öôÔ∏è</span>
                <div>
                    <div style="font-weight:600; letter-spacing: 0.5px;">PANNELLO AMMINISTRAZIONE</div>
                    <div style="font-size:0.7rem; opacity:0.8; font-style:italic;">Accademia delle Lingue</div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:20px;">
                <div style="text-align:right;">
                    <div style="font-weight:600; font-family: Georgia, serif;">Amministratore</div>
                    <div style="font-size:0.8rem;opacity:0.8;">Area Riservata</div>
                </div>
                <button onclick="logout()" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;padding:8px 16px;cursor:pointer; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Logout</button>
            </div>
        </nav>

        <div class="main-container">
            <aside class="sidebar">
                <div class="menu-category">Generale</div>
                <div class="nav-item active" onclick="showSection('home')" id="nav-home">
                    <span>üìä</span><span>Dashboard</span>
                </div>

                <div class="menu-category">Gestione Accessi</div>
                <div class="nav-item" onclick="showSection('requests')" id="nav-requests">
                    <span>üìù</span><span>Richieste Accesso</span>
                </div>
                <div class="nav-item" onclick="showSection('users')" id="nav-users">
                    <span>üë•</span><span>Gestione Utenti</span>
                </div>

                <div class="menu-category">Dati e Report</div>
                <div class="nav-item" onclick="showSection('scores')" id="nav-scores">
                    <span>üìà</span><span>Punteggi Studenti</span>
                </div>
                <div class="nav-item" onclick="showSection('passwords')" id="nav-passwords">
                    <span>üîê</span><span>Generatore Password</span>
                </div>

                <div class="menu-category">Sistema</div>
                <div class="nav-item" onclick="window.location.href='../index.html'">
                    <span>üéì</span><span>Torna alla Piattaforma</span>
                </div>
            </aside>

            <main class="content">
                <!-- DASHBOARD HOME -->
                <div id="home" class="section active">
                    <div class="breadcrumbs">
                        <strong>Dashboard Amministrativa</strong>
                    </div>

                    <div style="margin-bottom:32px;">
                        <h1 class="section-title">Pannello di Controllo</h1>
                        <p class="section-subtitle">Gestione completa della piattaforma e monitoraggio studenti</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Utenti Totali</div>
                            <div class="stat-value" id="stat-users">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Richieste in Attesa</div>
                            <div class="stat-value" id="stat-pending">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Test Completati</div>
                            <div class="stat-value" id="stat-scores">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Media Punteggi</div>
                            <div class="stat-value" id="stat-avg">0%</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">üì§ Esportazione Dati</div>
                        <div class="card-body">
                            <p style="margin-bottom: 1rem; color: var(--text-secondary);">Scarica i dati della piattaforma in formato Excel (CSV)</p>
                            <button class="btn btn-success" onclick="exportScores()" style="width: auto; display: inline-block; margin-right: 1rem;">
                                üìä Esporta Punteggi
                            </button>
                            <button class="btn" onclick="exportUsers()" style="width: auto; display: inline-block;">
                                üë• Esporta Utenti
                            </button>
                        </div>
                    </div>
                </div>

                <!-- RICHIESTE ACCESSO -->
                <div id="requests" class="section">
                    <div class="breadcrumbs">
                        <span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Richieste Accesso</strong>
                    </div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Richieste di Accesso</h1>
                        <p class="section-subtitle">Approva le richieste e invia le credenziali agli studenti</p>
                    </div>
                    <div class="card">
                        <div class="card-header">Elenco Richieste in Attesa</div>
                        <div class="card-body">
                            <table class="data-table" id="requests-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Motivazione</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- GESTIONE UTENTI -->
                <div id="users" class="section">
                    <div class="breadcrumbs">
                        <span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Gestione Utenti</strong>
                    </div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Utenti Registrati</h1>
                        <p class="section-subtitle">Visualizza e gestisci gli account degli studenti</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Elenco Studenti</span>
                                <button class="btn btn-success" onclick="addUser()" style="width: auto; padding: 8px 16px; font-size: 0.85rem;">‚ûï Aggiungi Utente</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="data-table" id="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Password</th>
                                        <th>Dispositivi</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PUNTEGGI -->
                <div id="scores" class="section">
                    <div class="breadcrumbs">
                        <span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Punteggi Studenti</strong>
                    </div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Registro Valutazioni</h1>
                        <p class="section-subtitle">Monitora i progressi e i risultati degli studenti</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Elenco Punteggi</span>
                                <button class="btn btn-success" onclick="exportScores()" style="width: auto; padding: 8px 16px; font-size: 0.85rem;">üìä Esporta Excel</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="data-table" id="scores-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Studente</th>
                                        <th>Email</th>
                                        <th>Modulo</th>
                                        <th>Punteggio</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- GENERATORE PASSWORD -->
                <div id="passwords" class="section">
                    <div class="breadcrumbs">
                        <span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Generatore Password</strong>
                    </div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Generatore Password Sicure</h1>
                        <p class="section-subtitle">Crea password robuste per gli account degli studenti</p>
                    </div>
                    <div class="card">
                        <div class="card-header">Genera Nuova Password</div>
                        <div class="card-body">
                            <div class="password-box">
                                <p style="margin-bottom: 1rem;">Clicca il pulsante per generare una password sicura di 12 caratteri</p>
                                <div class="password-display" id="generated-password">...</div>
                                <button class="btn" onclick="generatePassword()" style="width: auto; display: inline-block; margin-right: 1rem;">üîÑ Genera Password</button>
                                <button class="btn btn-success" onclick="copyPassword()" style="width: auto; display: inline-block;">üìã Copia</button>
                            </div>
                            <div style="margin-top: 2rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #c9a227;">
                                <strong style="color: #92400e;">üìã Requisiti Password:</strong>
                                <ul style="margin-top: 0.5rem; margin-left: 1.5rem; color: #92400e;">
                                    <li>Minimo 12 caratteri</li>
                                    <li>Lettere maiuscole e minuscole</li>
                                    <li>Numeri e simboli speciali</li>
                                    <li>Non utilizzare dati personali</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Database
        let db = { users: [], requests: [], scores: [] };

        // Credenziali Admin (hardcoded)
        const ADMIN_EMAIL = 'admin@accademia.it';
        const ADMIN_PASSWORD = 'Admin2024!';
        const MAX_DEVICES = 2;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            initDB();

            // Check if logged in
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showDashboard();
            }

            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showDashboard();
                } else {
                    document.getElementById('loginError').textContent = 'Credenziali non valide. Accesso negato.';
                    document.getElementById('loginError').style.display = 'block';
                }
            });
        });

        function initDB() {
            const stored = localStorage.getItem('accademia_data');
            if (stored) {
                db = JSON.parse(stored);
            } else {
                db.users.push({
                    id: 'admin001',
                    email: ADMIN_EMAIL,
                    password: ADMIN_PASSWORD,
                    name: 'Amministratore',
                    role: 'admin',
                    devices: [],
                    created: new Date().toISOString()
                });
                saveDB();
            }
        }

        function saveDB() {
            localStorage.setItem('accademia_data', JSON.stringify(db));
        }

        function getDeviceId() {
            // Genera o recupera un ID univoco per il dispositivo
            let deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('device_id', deviceId);
            }
            return deviceId;
        }

        function getDeviceInfo() {
            return {
                id: getDeviceId(),
                userAgent: navigator.userAgent.substring(0, 50),
                timestamp: new Date().toISOString()
            };
        }

        function checkDeviceLimit(user) {
            const deviceId = getDeviceId();
            
            // Se il dispositivo √® gi√† registrato, permetti l'accesso
            if (user.devices && user.devices.some(d => d.id === deviceId)) {
                return { allowed: true, reason: 'device_known' };
            }

            // Se non ci sono dispositivi registrati, inizializza l'array
            if (!user.devices) {
                user.devices = [];
            }

            // Se il limite √® raggiunto, nega l'accesso
            if (user.devices.length >= MAX_DEVICES) {
                return { 
                    allowed: false, 
                    reason: 'limit_reached',
                    devices: user.devices 
                };
            }

            // Registra il nuovo dispositivo
            user.devices.push(getDeviceInfo());
            saveDB();
            return { allowed: true, reason: 'device_added' };
        }

        function showDeviceLimitModal(userEmail, devices) {
            const modal = document.getElementById('deviceModal');
            const modalBody = document.getElementById('modalBody');
            
            let devicesHtml = '<div class="device-list">';
            devicesHtml += '<p><strong>Dispositivi registrati:</strong></p>';
            devices.forEach((dev, index) => {
                devicesHtml += `
                    <div class="device-item">
                        ${index + 1}. ${dev.userAgent}...<br>
                        <small>Registrato il: ${new Date(dev.timestamp).toLocaleString('it-IT')}</small>
                    </div>
                `;
            });
            devicesHtml += '</div>';
            
            modalBody.innerHTML = `
                <div class="alert alert-warning" style="display: block;">
                    <strong>Hai raggiunto il limite massimo di ${MAX_DEVICES} dispositivi.</strong>
                </div>
                <p>Hai gi√† registrato il numero massimo di dispositivi per l'account <strong>${userEmail}</strong>.</p>
                <p>Per accedere da un nuovo dispositivo, contatta l'amministratore.</p>
                ${devicesHtml}
            `;
            
            modal.classList.add('show');
        }

        function closeDeviceModal() {
            document.getElementById('deviceModal').classList.remove('show');
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateStats();
            loadRequests();
            loadUsers();
            loadScores();
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            window.location.reload();
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');
            document.getElementById('nav-' + sectionId).classList.add('active');

            if (sectionId === 'requests') loadRequests();
            if (sectionId === 'users') loadUsers();
            if (sectionId === 'scores') loadScores();
        }

        function updateStats() {
            document.getElementById('stat-users').textContent = db.users.filter(u => u.role !== 'admin').length;
            document.getElementById('stat-pending').textContent = db.requests.filter(r => r.status === 'pending').length;
            document.getElementById('stat-scores').textContent = db.scores.length;

            const avg = db.scores.length > 0 
                ? Math.round(db.scores.reduce((a, s) => a + s.percentage, 0) / db.scores.length)
                : 0;
            document.getElementById('stat-avg').textContent = avg + '%';
        }

        function loadRequests() {
            const tbody = document.querySelector('#requests-table tbody');
            const requests = db.requests;

            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nessuna richiesta presente</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(r => {
                let statusBadge = '';
                let actionButtons = '';
                
                if (r.status === 'pending') {
                    statusBadge = '<span class="badge badge-pending">In Attesa</span>';
                    actionButtons = `
                        <button class="btn btn-success" onclick="approveRequest('${r.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem; margin-right: 0.5rem;">‚úì Approva</button>
                        <button class="btn btn-danger" onclick="rejectRequest('${r.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">‚úó Rifiuta</button>
                    `;
                } else if (r.status === 'approved') {
                    statusBadge = '<span class="badge badge-approved">Approvata</span>';
                    if (r.passwordSent) {
                        actionButtons = '<span style="color: var(--success); font-size: 0.85rem;">‚úì Password inviata</span>';
                    } else {
                        actionButtons = `<button class="btn btn-warning" onclick="sendPassword('${r.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">üìß Invia Password</button>`;
                    }
                } else if (r.status === 'rejected') {
                    statusBadge = '<span class="badge" style="background: #fee2e2; color: #991b1b;">Rifiutata</span>';
                    actionButtons = '-';
                }

                return `
                    <tr>
                        <td>${new Date(r.created).toLocaleDateString('it-IT')}</td>
                        <td>${r.name}</td>
                        <td>${r.email}</td>
                        <td>${r.motivation ? r.motivation.substring(0, 50) + '...' : '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            }).join('');
        }

        function approveRequest(id) {
            const req = db.requests.find(r => r.id === id);
            if (!req) return;

            // Genera password
            const password = generateRandomPassword();
            req.tempPassword = password;
            req.status = 'approved';
            req.approvedAt = new Date().toISOString();
            
            saveDB();
            loadRequests();

            // Mostra dialogo per invio email
            showSendPasswordDialog(req);
        }

        function showSendPasswordDialog(req) {
            const message = `
‚úÖ RICHIESTA APPROVATA

Studente: ${req.name}
Email: ${req.email}
Password generata: ${req.tempPassword}

Clicca "Invia Email" per inviare le credenziali allo studente, 
oppure "Annulla" per approvare senza inviare (potrai inviare dopo).
            `;
            
            if (confirm(message + '\n\nVuoi inviare subito l\'email con le credenziali?')) {
                sendPassword(req.id);
            }
        }

        function sendPassword(requestId) {
            const req = db.requests.find(r => r.id === requestId);
            if (!req || !req.tempPassword) {
                alert('Errore: password non trovata. Rigenera la richiesta.');
                return;
            }

            // Simula invio email
            const emailContent = `
OGGETTO: Credenziali di Accesso - Accademia delle Lingue

Gentile ${req.name},

La tua richiesta di accesso √® stata approvata.

CREDENZIALI DI ACCESSO:
Email: ${req.email}
Password: ${req.tempPassword}

LINK ACCESSO: [URL della piattaforma]

IMPORTANTE:
- Puoi accedere da massimo 2 dispositivi
- Conserva questa email in un luogo sicuro
- Al primo accesso ti consigliamo di cambiare password

Cordiali saluti,
Amministrazione Accademia delle Lingue
            `;

            // Simula l'invio (in produzione qui ci sarebbe una chiamata API)
            console.log('Email inviata a:', req.email);
            console.log('Contenuto:', emailContent);
            
            // Marca come inviata
            req.passwordSent = true;
            req.passwordSentAt = new Date().toISOString();
            saveDB();
            loadRequests();

            alert(`üìß EMAIL INVIATA (simulazione)\n\nDestinatario: ${req.email}\n\nIn una implementazione reale, qui verrebbe inviata un'email automatica tramite server SMTP.`);
        }

        function rejectRequest(id) {
            if (!confirm('Sei sicuro di voler rifiutare questa richiesta?')) return;
            
            const req = db.requests.find(r => r.id === id);
            if (req) {
                req.status = 'rejected';
                req.rejectedAt = new Date().toISOString();
                saveDB();
                loadRequests();
            }
        }

        function loadUsers() {
            const tbody = document.querySelector('#users-table tbody');
            const students = db.users.filter(u => u.role !== 'admin');

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nessuno studente registrato</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(u => {
                const deviceCount = u.devices ? u.devices.length : 0;
                const deviceInfo = deviceCount > 0 
                    ? `${deviceCount}/${MAX_DEVICES} <button onclick="viewDevices('${u.id}')" style="margin-left: 8px; font-size: 0.75rem;">üëÅÔ∏è Vedi</button>`
                    : '0/' + MAX_DEVICES;
                
                return `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td><code style="background: var(--bg-primary); padding: 4px 8px; font-family: monospace;">${u.password}</code></td>
                        <td>${deviceInfo}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteUser('${u.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem; margin-right: 0.5rem;">üóëÔ∏è Elimina</button>
                            <button class="btn btn-warning" onclick="resetDevices('${u.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">üîÑ Reset Disp.</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewDevices(userId) {
            const user = db.users.find(u => u.id === userId);
            if (!user || !user.devices || user.devices.length === 0) {
                alert('Nessun dispositivo registrato per questo utente.');
                return;
            }

            let devicesText = `DISPOSITIVI REGISTRATI PER ${user.name} (${user.email}):\n\n`;
            user.devices.forEach((dev, index) => {
                devicesText += `${index + 1}. ID: ${dev.id}\n`;
                devicesText += `   Browser: ${dev.userAgent}\n`;
                devicesText += `   Registrato il: ${new Date(dev.timestamp).toLocaleString('it-IT')}\n\n`;
            });

            alert(devicesText);
        }

        function resetDevices(userId) {
            if (!confirm('‚ö†Ô∏è ATTENZIONE\n\nQuesto canceller√† TUTTI i dispositivi registrati per questo utente.\nL\'utente dovr√† accedere nuovamente e registrare i dispositivi.\n\nSei sicuro?')) return;

            const user = db.users.find(u => u.id === userId);
            if (user) {
                user.devices = [];
                saveDB();
                loadUsers();
                alert('‚úÖ Dispositivi resettati con successo.');
            }
        }

        function deleteUser(id) {
            if (!confirm('Sei sicuro di voler eliminare questo utente?')) return;
            db.users = db.users.filter(u => u.id !== id);
            saveDB();
            loadUsers();
            updateStats();
        }

        function addUser() {
            const name = prompt('Nome completo:');
            if (!name) return;
            const email = prompt('Email:');
            if (!email) return;

            const password = generateRandomPassword();

            const newUser = {
                id: 'user_' + Date.now(),
                email: email,
                password: password,
                name: name,
                role: 'student',
                devices: [],
                created: new Date().toISOString()
            };

            db.users.push(newUser);
            saveDB();

            // Mostra credenziali e opzione invio
            const message = `
‚úÖ UTENTE CREATO

Nome: ${name}
Email: ${email}
Password: ${password}

Vuoi inviare subito l'email con le credenziali?
            `;
            
            if (confirm(message)) {
                // Simula invio
                alert(`üìß Email inviata a ${email}\n\nContenuto:\nEmail: ${email}\nPassword: ${password}`);
            }

            loadUsers();
            updateStats();
        }

        function loadScores() {
            const tbody = document.querySelector('#scores-table tbody');

            if (db.scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nessun punteggio registrato</td></tr>';
                return;
            }

            tbody.innerHTML = db.scores.map(s => `
                <tr>
                    <td>${new Date(s.completedAt).toLocaleDateString('it-IT')}</td>
                    <td>${s.userName}</td>
                    <td>${s.userEmail}</td>
                    <td>${s.moduleName}</td>
                    <td>${s.score}/${s.maxScore}</td>
                    <td><strong>${s.percentage}%</strong></td>
                </tr>
            `).join('');
        }

        function generatePassword() {
            const pwd = generateRandomPassword();
            document.getElementById('generated-password').textContent = pwd;
        }

        function generateRandomPassword() {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let pwd = "";
            for (let i = 0; i < 12; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return pwd;
        }

        function copyPassword() {
            const pwd = document.getElementById('generated-password').textContent;
            if (pwd && pwd !== '...') {
                navigator.clipboard.writeText(pwd);
                alert('Password copiata negli appunti!');
            }
        }

        function exportScores() {
            if (db.scores.length === 0) {
                alert('Nessun punteggio da esportare');
                return;
            }

            const data = db.scores.map(s => ({
                Data: new Date(s.completedAt).toLocaleString('it-IT'),
                Studente: s.userName,
                Email: s.userEmail,
                Modulo: s.moduleName,
                Punteggio: s.score,
                Max: s.maxScore,
                Percentuale: s.percentage + '%'
            }));

            downloadCSV(data, 'punteggi_accademia');
        }

        function exportUsers() {
            const students = db.users.filter(u => u.role !== 'admin');
            if (students.length === 0) {
                alert('Nessun utente da esportare');
                return;
            }

            const data = students.map(u => ({
                ID: u.id,
                Nome: u.name,
                Email: u.email,
                Ruolo: u.role,
                Dispositivi: u.devices ? u.devices.length : 0,
                'Data Registrazione': new Date(u.created).toLocaleString('it-IT')
            }));

            downloadCSV(data, 'utenti_accademia');
        }

        function downloadCSV(data, filename) {
            const headers = Object.keys(data[0]);
            let csv = headers.join(';') + '\n';

            data.forEach(row => {
                csv += headers.map(h => row[h]).join(';') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // Funzioni per la pagina studente (da includere in index.html)
        // Queste funzioni sono esposte globalmente per essere usate dalla pagina studente
        
        window.studentLogin = function(email, password) {
            const user = db.users.find(u => u.email === email && u.password === password && u.role === 'student');
            
            if (!user) {
                return { success: false, error: 'Credenziali non valide' };
            }

            // Verifica limite dispositivi
            const deviceCheck = checkDeviceLimit(user);
            
            if (!deviceCheck.allowed) {
                return { 
                    success: false, 
                    error: 'limit_reached',
                    devices: deviceCheck.devices 
                };
            }

            // Salva sessione
            sessionStorage.setItem('studentLoggedIn', 'true');
            sessionStorage.setItem('studentEmail', email);
            sessionStorage.setItem('studentId', user.id);
            
            return { success: true, user: user };
        };

        window.checkStudentSession = function() {
            return sessionStorage.getItem('studentLoggedIn') === 'true';
        };

        window.studentLogout = function() {
            sessionStorage.removeItem('studentLoggedIn');
            sessionStorage.removeItem('studentEmail');
            sessionStorage.removeItem('studentId');
        };

        window.getStudentData = function() {
            if (!window.checkStudentSession()) return null;
            const email = sessionStorage.getItem('studentEmail');
            return db.users.find(u => u.email === email);
        };

        window.saveScore = function(moduleName, score, maxScore) {
            const user = window.getStudentData();
            if (!user) return false;

            const percentage = Math.round((score / maxScore) * 100);
            
            db.scores.push({
                id: 'score_' + Date.now(),
                userId: user.id,
                userName: user.name,
                userEmail: user.email,
                moduleName: moduleName,
                score: score,
                maxScore: maxScore,
                percentage: percentage,
                completedAt: new Date().toISOString()
            });

            saveDB();
            return true;
        };

        window.registerAccessRequest = function(name, email, motivation) {
            // Verifica se esiste gi√†
            const existing = db.requests.find(r => r.email === email);
            if (existing) {
                return { success: false, error: 'Esiste gi√† una richiesta per questa email' };
            }

            const existingUser = db.users.find(u => u.email === email);
            if (existingUser) {
                return { success: false, error: 'Esiste gi√† un utente con questa email' };
            }

            db.requests.push({
                id: 'req_' + Date.now(),
                name: name,
                email: email,
                motivation: motivation,
                status: 'pending',
                created: new Date().toISOString()
            });

            saveDB();
            return { success: true };
        };
    </script>
</body>
</html>
