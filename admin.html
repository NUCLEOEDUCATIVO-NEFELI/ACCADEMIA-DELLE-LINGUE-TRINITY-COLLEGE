<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello Amministrazione - Accademia delle Lingue</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1e3a5f; --primary-dark: #152a45; --secondary: #8b0000;
            --success: #276749; --error: #c53030; --warning: #d97706;
            --bg-primary: #f5f5f0; --bg-card: #ffffff; --border: #d4d4c8;
            --text-primary: #2c3e50; --text-secondary: #5a6c7d;
        }
        body { font-family: 'Georgia', 'Times New Roman', serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; }
        .login-section { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-primary); padding: 20px; }
        .login-container { width: 100%; max-width: 480px; background: var(--bg-card); box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; border: 1px solid var(--border); }
        .login-header { background: var(--primary); padding: 40px 30px; text-align: center; color: white; border-bottom: 3px solid var(--secondary); }
        .login-logo { font-size: 3rem; margin-bottom: 16px; }
        .login-body { padding: 32px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--border); font-size: 1rem; font-family: inherit; background: #fafafa; }
        .form-input:focus { outline: none; border-color: var(--primary); background: white; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; }
        .btn:hover { background: var(--primary-dark); }
        .btn-secondary { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover { background: var(--primary); color: white; }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--error); }
        .form-footer { text-align: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
        .form-footer a { color: var(--primary); font-weight: 600; text-decoration: none; }
        .alert { padding: 12px 16px; margin-bottom: 16px; display: none; border-left: 4px solid; }
        .alert-error { background: #fed7d7; color: var(--error); border-left-color: var(--error); display: block; }
        .alert-success { background: #c6f6d5; color: var(--success); border-left-color: var(--success); display: block; }
        .dashboard { display: none; min-height: 100vh; }
        .top-nav { background: var(--primary); color: white; padding: 0 24px; height: 64px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--secondary); }
        .main-container { display: flex; min-height: calc(100vh - 64px); }
        .sidebar { width: 300px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 24px 0; box-shadow: 2px 0 4px rgba(0,0,0,0.05); overflow-y: auto; max-height: calc(100vh - 64px); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin: 0 12px 4px 12px; cursor: pointer; color: var(--text-secondary); border-left: 3px solid transparent; transition: all 0.2s; font-size: 0.9rem; }
        .nav-item:hover { background: var(--bg-primary); color: var(--text-primary); border-left-color: var(--border); }
        .nav-item.active { background: var(--bg-primary); color: var(--primary); border-left-color: var(--secondary); font-weight: 600; }
        .content { flex: 1; padding: 32px; background: var(--bg-primary); overflow-y: auto; max-height: calc(100vh - 64px); }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: var(--bg-card); box-shadow: 0 2px 4px rgba(0,0,0,0.08); border: 1px solid var(--border); margin-bottom: 24px; }
        .card-header { padding: 20px 24px; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.95rem; }
        .card-body { padding: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); padding: 24px; text-align: center; border-left: 4px solid var(--secondary); }
        .stat-label { color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: var(--primary); font-family: 'Times New Roman', serif; }
        .section-title { font-size: 1.75rem; color: var(--primary); font-weight: normal; margin-bottom: 8px; border-bottom: 2px solid var(--secondary); padding-bottom: 12px; }
        .section-subtitle { color: var(--text-secondary); font-style: italic; margin-bottom: 24px; }
        .menu-category { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin: 16px 12px 8px 12px; padding-left: 12px; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .data-table { width: 100%; border-collapse: collapse; background: white; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.08); border: 1px solid var(--border); }
        .data-table th { background: var(--primary); color: white; padding: 1rem; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        .data-table td { padding: 1rem; border-bottom: 1px solid var(--border); }
        .data-table tr:hover { background: var(--bg-primary); }
        .badge { padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #dcfce7; color: #166534; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }
        .breadcrumbs { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 12px 24px; font-size: 0.85rem; color: var(--text-secondary); margin: -32px -32px 24px -32px; }
        .breadcrumbs strong { color: var(--text-primary); }
        .password-box { background: #f0fdf4; border: 2px dashed var(--success); padding: 2rem; text-align: center; margin: 1rem 0; }
        .password-display { font-family: 'Courier New', monospace; font-size: 1.5rem; color: var(--primary); background: white; padding: 1rem; margin: 1rem 0; letter-spacing: 2px; border: 2px solid var(--border); word-break: break-all; }
        .device-list { background: var(--bg-primary); padding: 1rem; margin: 8px 0; border-left: 3px solid var(--warning); font-size: 0.85rem; }
        .device-item { padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-family: monospace; }
        @media (max-width: 768px) { .sidebar { width: 100%; position: fixed; bottom: 0; left: 0; z-index: 100; max-height: 60vh; overflow-y: auto; display: none; } }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginSection" class="login-section">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">‚öôÔ∏è</div>
                <h1 style="font-size: 1.3rem; font-weight: normal;">PANNELLO AMMINISTRAZIONE</h1>
                <p style="font-size: 0.8rem; margin-top: 8px; font-style: italic;">Accademia delle Lingue</p>
            </div>
            <div class="login-body">
                <div id="loginError" class="alert alert-error" style="display: none;"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email Amministratore</label>
                        <input type="email" id="loginEmail" class="form-input" required placeholder="admin@accademia.it"/>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required placeholder="Password"/>
                    </div>
                    <button type="submit" class="btn">Accedi all'Area Riservata</button>
                    <div class="form-footer">
                        <p><a href="login.html">‚Üê Torna alla Piattaforma Studenti</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="dashboard">
        <nav class="top-nav">
            <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:1.5rem;">‚öôÔ∏è</span>
                <div>
                    <div style="font-weight:600; letter-spacing: 0.5px;">PANNELLO AMMINISTRAZIONE</div>
                    <div style="font-size:0.7rem; opacity:0.8; font-style:italic;">Accademia delle Lingue</div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:20px;">
                <div style="text-align:right;">
                    <div style="font-weight:600; font-family: Georgia, serif;">Amministratore</div>
                    <div style="font-size:0.8rem;opacity:0.8;">Area Riservata</div>
                </div>
                <button onclick="logout()" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;padding:8px 16px;cursor:pointer; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Logout</button>
            </div>
        </nav>

        <div class="main-container">
            <aside class="sidebar">
                <div class="menu-category">Generale</div>
                <div class="nav-item active" onclick="showSection('home')" id="nav-home"><span>üìä</span><span>Dashboard</span></div>
                <div class="menu-category">Gestione Accessi</div>
                <div class="nav-item" onclick="showSection('requests')" id="nav-requests"><span>üìù</span><span>Richieste Accesso</span></div>
                <div class="nav-item" onclick="showSection('users')" id="nav-users"><span>üë•</span><span>Gestione Utenti</span></div>
                <div class="menu-category">Dati e Report</div>
                <div class="nav-item" onclick="showSection('scores')" id="nav-scores"><span>üìà</span><span>Punteggi Studenti</span></div>
                <div class="nav-item" onclick="showSection('passwords')" id="nav-passwords"><span>üîê</span><span>Generatore Password</span></div>
            </aside>

            <main class="content">
                <!-- HOME -->
                <div id="home" class="section active">
                    <div class="breadcrumbs"><strong>Dashboard Amministrativa</strong></div>
                    <div style="margin-bottom:32px;">
                        <h1 class="section-title">Pannello di Controllo</h1>
                        <p class="section-subtitle">Gestione completa della piattaforma e monitoraggio studenti</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-label">Utenti Totali</div><div class="stat-value" id="stat-users">0</div></div>
                        <div class="stat-card"><div class="stat-label">Richieste in Attesa</div><div class="stat-value" id="stat-pending">0</div></div>
                        <div class="stat-card"><div class="stat-label">Test Completati</div><div class="stat-value" id="stat-scores">0</div></div>
                        <div class="stat-card"><div class="stat-label">Media Punteggi</div><div class="stat-value" id="stat-avg">0%</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header">üì§ Esportazione Dati</div>
                        <div class="card-body">
                            <p style="margin-bottom: 1rem; color: var(--text-secondary);">Scarica i dati della piattaforma in formato CSV</p>
                            <button class="btn btn-success" onclick="exportScores()" style="width: auto; display: inline-block; margin-right: 1rem;">üìä Esporta Punteggi</button>
                            <button class="btn" onclick="exportUsers()" style="width: auto; display: inline-block;">üë• Esporta Utenti</button>
                        </div>
                    </div>
                </div>

                <!-- RICHIESTE -->
                <div id="requests" class="section">
                    <div class="breadcrumbs"><span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Richieste Accesso</strong></div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Richieste di Accesso</h1>
                        <p class="section-subtitle">Approva le richieste e genera password per gli studenti</p>
                    </div>
                    <div class="card">
                        <div class="card-header">Elenco Richieste</div>
                        <div class="card-body">
                            <table class="data-table" id="requests-table">
                                <thead>
                                    <tr><th>Data</th><th>Nome</th><th>Email</th><th>Piattaforma</th><th>Motivazione</th><th>Stato</th><th>Azioni</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- UTENTI -->
                <div id="users" class="section">
                    <div class="breadcrumbs"><span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Gestione Utenti</strong></div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Utenti Registrati</h1>
                        <p class="section-subtitle">Visualizza e gestisci gli account degli studenti (max 1 dispositivo)</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Elenco Studenti</span>
                                <button class="btn btn-success" onclick="addUser()" style="width: auto; padding: 8px 16px; font-size: 0.85rem;">‚ûï Aggiungi Utente</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="data-table" id="users-table">
                                <thead>
                                    <tr><th>ID</th><th>Nome</th><th>Email</th><th>Piattaforma</th><th>Password</th><th>Dispositivo</th><th>Stato</th><th>Azioni</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PUNTEGGI -->
                <div id="scores" class="section">
                    <div class="breadcrumbs"><span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Punteggi Studenti</strong></div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Registro Valutazioni</h1>
                        <p class="section-subtitle">Monitora i progressi degli studenti</p>
                    </div>
                    <div class="card">
                        <div class="card-header">Elenco Punteggi</div>
                        <div class="card-body">
                            <table class="data-table" id="scores-table">
                                <thead>
                                    <tr><th>Data</th><th>Studente</th><th>Email</th><th>Modulo</th><th>Punteggio</th><th>%</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PASSWORD -->
                <div id="passwords" class="section">
                    <div class="breadcrumbs"><span onclick="showSection('home')" style="cursor: pointer;">Dashboard</span> / <strong>Generatore Password</strong></div>
                    <div style="margin:24px 0;">
                        <h1 class="section-title">Generatore Password Sicure</h1>
                        <p class="section-subtitle">Crea password robuste per gli account degli studenti</p>
                    </div>
                    <div class="card">
                        <div class="card-header">Genera Nuova Password</div>
                        <div class="card-body">
                            <div class="password-box">
                                <p>Clicca per generare una password sicura di 12 caratteri</p>
                                <div class="password-display" id="generated-password">...</div>
                                <button class="btn" onclick="generatePassword()" style="width: auto; display: inline-block; margin-right: 1rem;">üîÑ Genera</button>
                                <button class="btn btn-success" onclick="copyPassword()" style="width: auto; display: inline-block;">üìã Copia</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Config
        const ADMIN_EMAIL = 'admin@accademia.it';
        const ADMIN_PASSWORD = 'Admin2024!';
        
        let db = { users: [], requests: [], scores: [] };

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            initDB();
            
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showDashboard();
            }

            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showDashboard();
                } else {
                    document.getElementById('loginError').textContent = 'Credenziali non valide';
                    document.getElementById('loginError').style.display = 'block';
                }
            });
        });

        function initDB() {
            const stored = localStorage.getItem('accademia_data');
            if (stored) {
                db = JSON.parse(stored);
                if (!db.users) db.users = [];
                if (!db.requests) db.requests = [];
                if (!db.scores) db.scores = [];
            } else {
                db.users.push({
                    id: 'admin001', email: ADMIN_EMAIL, password: ADMIN_PASSWORD,
                    name: 'Amministratore', role: 'admin', platform: 'trinity',
                    created: new Date().toISOString()
                });
                saveDB();
            }
        }

        function saveDB() {
            localStorage.setItem('accademia_data', JSON.stringify(db));
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateStats();
            loadRequests();
            loadUsers();
            loadScores();
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            window.location.reload();
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.getElementById('nav-' + sectionId).classList.add('active');
            
            if (sectionId === 'requests') loadRequests();
            if (sectionId === 'users') loadUsers();
            if (sectionId === 'scores') loadScores();
        }

        function updateStats() {
            document.getElementById('stat-users').textContent = db.users.filter(u => u.role !== 'admin').length;
            document.getElementById('stat-pending').textContent = db.requests.filter(r => r.status === 'pending').length;
            document.getElementById('stat-scores').textContent = db.scores.length;
            
            const avg = db.scores.length > 0 
                ? Math.round(db.scores.reduce((a, s) => a + s.percentage, 0) / db.scores.length)
                : 0;
            document.getElementById('stat-avg').textContent = avg + '%';
        }

        function loadRequests() {
            const tbody = document.querySelector('#requests-table tbody');
            
            if (db.requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">Nessuna richiesta presente</td></tr>';
                return;
            }

            tbody.innerHTML = db.requests.map(r => {
                let statusBadge = '';
                let actions = '';
                
                if (r.status === 'pending') {
                    statusBadge = '<span class="badge badge-pending">In Attesa</span>';
                    actions = `<button class="btn btn-success" onclick="approveRequest('${r.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem; margin-right: 0.5rem;">‚úì Approva</button>
                              <button class="btn btn-danger" onclick="rejectRequest('${r.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">‚úó Rifiuta</button>`;
                } else if (r.status === 'approved') {
                    statusBadge = '<span class="badge badge-approved">Approvata</span>';
                    actions = `<button class="btn btn-secondary" onclick="showCredentials('${r.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">üëÅÔ∏è Vedi Credenziali</button>`;
                } else {
                    statusBadge = '<span class="badge badge-rejected">Rifiutata</span>';
                    actions = '-';
                }

                return `<tr>
                    <td>${new Date(r.created).toLocaleDateString('it-IT')}</td>
                    <td>${r.name}</td>
                    <td>${r.email}</td>
                    <td>${r.platform ? r.platform.toUpperCase() : 'N/A'}</td>
                    <td>${r.motivation ? r.motivation.substring(0, 30) + '...' : '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${actions}</td>
                </tr>`;
            }).join('');
        }

        function approveRequest(id) {
            const req = db.requests.find(r => r.id === id);
            if (!req) return;

            const password = generateRandomPassword(req.platform);
            req.tempPassword = password;
            req.status = 'approved';
            req.approvedAt = new Date().toISOString();
            
            // Crea utente
            db.users.push({
                id: 'user_' + Date.now(),
                email: req.email,
                password: password,
                name: req.name,
                platform: req.platform,
                role: 'student',
                devices: [],
                created: new Date().toISOString(),
                firstLogin: true // Deve cambiare password
            });
            
            saveDB();
            loadRequests();
            updateStats();

            // Mostra credenziali
            alert(`‚úÖ RICHIESTA APPROVATA\n\nStudente: ${req.name}\nEmail: ${req.email}\nPassword temporanea: ${password}\n\n‚ö†Ô∏è IMPORTANTE: Al primo login lo studente dovr√† obbligatoriamente cambiare password e potr√† usare solo questo dispositivo.`);
        }

        function showCredentials(id) {
            const req = db.requests.find(r => r.id === id);
            if (req && req.tempPassword) {
                alert(`üìß CREDENZIALI STUDENTE\n\nNome: ${req.name}\nEmail: ${req.email}\nPassword: ${req.tempPassword}\n\nComunica queste credenziali allo studente.`);
            }
        }

        function rejectRequest(id) {
            if (!confirm('Rifiutare questa richiesta?')) return;
            const req = db.requests.find(r => r.id === id);
            if (req) {
                req.status = 'rejected';
                req.rejectedAt = new Date().toISOString();
                saveDB();
                loadRequests();
            }
        }

        function loadUsers() {
            const tbody = document.querySelector('#users-table tbody');
            const students = db.users.filter(u => u.role !== 'admin');

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">Nessuno studente registrato</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(u => {
                const deviceInfo = u.devices && u.devices.length > 0 
                    ? `<div class="device-list" style="margin:0; padding:4px;">
                         <div class="device-item" style="border:none; padding:2px 0;">
                           ${u.devices[0].id.substr(-12)}<br>
                           <small>${new Date(u.devices[0].timestamp).toLocaleDateString('it-IT')}</small>
                         </div>
                       </div>`
                    : '<em style="color:var(--text-secondary);">Non registrato</em>';
                
                const status = u.firstLogin === true 
                    ? '<span style="color: var(--warning);">‚è≥ Attende primo login</span>'
                    : '<span style="color: var(--success);">‚úì Attivo</span>';
                
                return `<tr>
                    <td>${u.id.substr(-6)}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.platform ? u.platform.toUpperCase() : 'N/A'}</td>
                    <td><code style="background: var(--bg-primary); padding: 4px 8px; font-family: monospace;">${u.password}</code></td>
                    <td>${deviceInfo}</td>
                    <td>${status}</td>
                    <td>
                        <button class="btn btn-warning" onclick="resetDevice('${u.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem; margin-right: 0.5rem;">üîÑ Reset</button>
                        <button class="btn btn-danger" onclick="deleteUser('${u.id}')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function resetDevice(userId) {
            const user = db.users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`‚ö†Ô∏è Reset dispositivo per ${user.name}?\n\nQuesto permetter√† all'utente di accedere da un nuovo dispositivo, ma dovr√† reimpostare la password.`)) {
                user.devices = [];
                user.firstLogin = true;
                saveDB();
                loadUsers();
                alert('‚úÖ Dispositivo resettato. Lo studente dovr√† fare login con password temporanea.');
            }
        }

        function deleteUser(id) {
            if (!confirm('Eliminare permanentemente questo utente?')) return;
            db.users = db.users.filter(u => u.id !== id);
            saveDB();
            loadUsers();
            updateStats();
        }

        function addUser() {
            const name = prompt('Nome completo:');
            if (!name) return;
            const email = prompt('Email:');
            if (!email) return;
            const platform = prompt('Piattaforma (italiano/trinity/toefl):', 'trinity');
            
            const password = generateRandomPassword(platform);
            
            db.users.push({
                id: 'user_' + Date.now(),
                email: email,
                password: password,
                name: name,
                platform: platform || 'trinity',
                role: 'student',
                devices: [],
                created: new Date().toISOString(),
                firstLogin: true
            });
            
            saveDB();
            
            alert(`‚úÖ UTENTE CREATO\n\nNome: ${name}\nEmail: ${email}\nPassword: ${password}\n\nLo studente dovr√† cambiare password al primo login.`);
            loadUsers();
            updateStats();
        }

        function loadScores() {
            const tbody = document.querySelector('#scores-table tbody');
            
            if (db.scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Nessun punteggio registrato</td></tr>';
                return;
            }

            tbody.innerHTML = db.scores.map(s => `
                <tr>
                    <td>${new Date(s.completedAt).toLocaleDateString('it-IT')}</td>
                    <td>${s.userName}</td>
                    <td>${s.userEmail}</td>
                    <td>${s.moduleName}</td>
                    <td>${s.score}/${s.maxScore}</td>
                    <td><strong>${s.percentage}%</strong></td>
                </tr>
            `).join('');
        }

        function generatePassword() {
            const pwd = generateRandomPassword('trinity');
            document.getElementById('generated-password').textContent = pwd;
        }

        function generateRandomPassword(platform) {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let pwd = "";
            for (let i = 0; i < 12; i++) pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            
            const prefixes = { 'italiano': 'ITA_', 'trinity': 'TRI_', 'toefl': 'TOF_' };
            const suffixes = { 'italiano': '_CECOL', 'trinity': '_TRIN', 'toefl': '_TOEFL' };
            return (prefixes[platform] || 'TRI_') + pwd + (suffixes[platform] || '_TRIN');
        }

        function copyPassword() {
            const pwd = document.getElementById('generated-password').textContent;
            if (pwd && pwd !== '...') {
                navigator.clipboard.writeText(pwd);
                alert('Password copiata!');
            }
        }

        function exportScores() {
            if (db.scores.length === 0) { alert('Nessun punteggio'); return; }
            
            const data = db.scores.map(s => ({
                Data: new Date(s.completedAt).toLocaleString('it-IT'),
                Studente: s.userName, Email: s.userEmail,
                Modulo: s.moduleName, Punteggio: s.score, Max: s.maxScore, Percentuale: s.percentage + '%'
            }));
            
            downloadCSV(data, 'punteggi');
        }

        function exportUsers() {
            const students = db.users.filter(u => u.role !== 'admin');
            if (students.length === 0) { alert('Nessun utente'); return; }
            
            const data = students.map(u => ({
                ID: u.id, Nome: u.name, Email: u.email,
                Piattaforma: u.platform || 'N/A',
                Dispositivo: u.devices && u.devices.length > 0 ? 'Registrato' : 'Non registrato',
                Stato: u.firstLogin === true ? 'Attende primo login' : 'Attivo'
            }));
            
            downloadCSV(data, 'utenti');
        }

        function downloadCSV(data, filename) {
            const headers = Object.keys(data[0]);
            let csv = headers.join(';') + '\n';
            data.forEach(row => { csv += headers.map(h => row[h]).join(';') + '\n'; });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }
    </script>
</body>
</html>
